<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>题目搜索</title>
    
    <script defer src="../toggle-theme.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
            font-size: 14px;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        
        .search-container {
            max-width: 1200px;
            width: 100%;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
            margin-top: 20px;
        }
        
        .search-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .search-header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .search-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s ease;
        }
        
        .search-input:focus {
            border-color: #007bff;
        }
        
        .search-btn {
            padding: 12px 24px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        
        .search-btn:hover {
            background-color: #0056b3;
        }
        
        .filter-options {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-group label {
            font-weight: 500;
            color: #495057;
        }
        
        .chapter-select {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            background-color: white;
        }
        
        .question-type-filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .question-type-filters label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .results-info {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            font-weight: 500;
        }
        
        .question-item {
            background: #fff;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 20px;
            transition: box-shadow 0.3s ease;
        }
        
        .question-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .question-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .question-meta {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .chapter-tag {
            background-color: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .question-type-tag {
            background-color: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .locate-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            margin-left: auto;
        }
        
        .locate-btn:hover {
            background: #45a049;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .locate-btn:active {
            transform: translateY(0);
        }
        
        .question-content {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .question-options {
            margin-bottom: 15px;
        }
        
        .option-item {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 5px;
            background-color: #f8f9fa;
            border-left: 3px solid #dee2e6;
        }
        
        .option-item.correct {
            background-color: #d4edda;
            border-left-color: #28a745;
            font-weight: 500;
        }
        
        .answer-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #17a2b8;
        }
        
        .answer-label {
            font-weight: 600;
            color: #17a2b8;
            margin-bottom: 8px;
        }
        
        .answer-content {
            color: #495057;
            line-height: 1.5;
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-size: 18px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #007bff;
            font-size: 16px;
        }
        
        /* Font size controls */
        .font-size-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .font-size-controls label {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }
        
        .font-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            min-width: 40px;
        }
        
        .font-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }
        
        .font-btn:active {
            transform: translateY(0);
        }
        
        #fontSizeSlider {
            width: 300px;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            cursor: pointer;
        }
        
        #fontSizeSlider::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        #fontSizeSlider::-webkit-slider-thumb:hover {
            background: #0056b3;
        }
        
        #fontSizeSlider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
            border: none;
        }
        
        #fontSizeDisplay {
            font-weight: 600;
            color: #007bff;
            font-size: 14px;
            min-width: 40px;
            text-align: center;
        }
        
        /* Dark mode styles */
        html.dark-mode body {
            background-color: #1a1a1a;
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        
        html.dark-mode .search-container {
            background: #2a2a2a;
            color: #e0e0e0;
        }
        
        html.dark-mode .search-input {
            background-color: #3a3a3a;
            border-color: #555;
            color: #e0e0e0;
        }
        
        html.dark-mode .search-input:focus {
            border-color: #007bff;
        }
        
        html.dark-mode .chapter-select {
            background-color: #3a3a3a;
            border-color: #555;
            color: #e0e0e0;
        }
        
        html.dark-mode .results-info {
            background-color: #3a3a3a;
            color: #e0e0e0;
        }
        
        html.dark-mode .question-item {
            background: #2a2a2a;
            border-color: #555;
        }
        
        html.dark-mode .option-item {
            background-color: #3a3a3a;
            border-left-color: #555;
        }
        
        html.dark-mode .option-item.correct {
            background-color: #1e4d2b;
            border-left-color: #28a745;
        }
        
        html.dark-mode .answer-section {
            background-color: #3a3a3a;
        }
        
        html.dark-mode .search-header h1 {
            color: #e0e0e0;
        }
        
        html.dark-mode .question-content {
            color: #e0e0e0;
        }
        
        html.dark-mode .locate-btn {
            background: #388e3c;
            color: #e8f5e8;
        }
        
        html.dark-mode .locate-btn:hover {
            background: #2e7d32;
        }
        
        html.dark-mode .answer-label {
            color: #4fc3f7;
        }
        
        html.dark-mode .answer-content {
            color: #e0e0e0;
        }
        
        /* Dark mode font controls */
        html.dark-mode .font-size-controls {
            background-color: #3a3a3a;
            border-color: #555;
        }
        
        html.dark-mode .font-size-controls label {
            color: #e0e0e0;
        }
        
        html.dark-mode .font-btn {
            background: #495057;
            color: #e0e0e0;
        }
        
        html.dark-mode .font-btn:hover {
            background: #6c757d;
        }
        
        html.dark-mode #fontSizeSlider {
            background: #555;
        }
        
        html.dark-mode #fontSizeDisplay {
            color: #4fc3f7;
        }
        
        /* Dark mode highlight styles */
        html.dark-mode mark {
            background-color: #ffc107 !important;
            color: #000 !important;
        }
        
        /* Mobile responsive styles */
        @media (max-width: 768px) {
            body {
                font-size: 16px;
                padding: 10px;
            }
            
            .search-container {
                padding: 20px;
                margin-top: 10px;
                border-radius: 8px;
            }
            
            .search-header h1 {
                font-size: 24px;
                margin-bottom: 8px;
            }
            
            .search-header p {
                font-size: 16px;
            }
            
            .search-box {
                flex-direction: column;
                gap: 12px;
            }
            
            .search-input {
                padding: 16px 20px;
                font-size: 18px;
                border-radius: 10px;
            }
            
            .search-btn {
                padding: 16px 24px;
                font-size: 18px;
                border-radius: 10px;
                width: 100%;
            }
            
            .filter-options {
                flex-direction: column;
                gap: 20px;
                align-items: stretch;
            }
            
            .filter-group {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            
            .filter-group label {
                font-size: 16px;
                font-weight: 600;
            }
            
            .chapter-select {
                padding: 12px 16px;
                font-size: 16px;
                border-radius: 8px;
            }
            
            .question-type-filters {
                flex-direction: column;
                gap: 12px;
            }
            
            .question-type-filters label {
                font-size: 16px;
                padding: 8px 0;
            }
            
            .question-type-filters input[type="checkbox"] {
                width: 18px;
                height: 18px;
            }
            
            .results-info {
                padding: 15px;
                font-size: 16px;
                border-radius: 8px;
            }
            
            .question-item {
                padding: 20px;
                margin-bottom: 20px;
                border-radius: 10px;
            }
            
            .question-meta {
                gap: 12px;
                margin-bottom: 15px;
            }
            
            .chapter-tag, .question-type-tag {
                padding: 6px 12px;
                font-size: 14px;
                border-radius: 6px;
            }
            
            .locate-btn {
                padding: 10px 16px;
                font-size: 14px;
                border-radius: 20px;
                margin-top: 10px;
                margin-left: 0;
                align-self: flex-start;
            }
            
            .question-content {
                font-size: 18px;
                line-height: 1.6;
                margin-bottom: 20px;
            }
            
            .option-item {
                padding: 12px 16px;
                margin: 8px 0;
                font-size: 16px;
                border-radius: 8px;
            }
            
            .answer-section {
                padding: 20px;
                border-radius: 8px;
                margin-top: 15px;
            }
            
            .answer-label {
                font-size: 16px;
                margin-bottom: 12px;
            }
            
            .answer-content {
                font-size: 18px;
            }
        }
        
        /* Mobile responsive styles for font controls */
        @media (max-width: 768px) {
            .font-size-controls {
                flex-wrap: wrap;
                gap: 8px;
                padding: 12px;
            }
            
            .font-size-controls label {
                font-size: 16px;
                width: 100%;
                text-align: center;
                margin-bottom: 8px;
            }
            
            .font-btn {
                padding: 10px 14px;
                font-size: 16px;
                min-width: 45px;
            }
            
            #fontSizeSlider {
                width: 200px;
                height: 8px;
            }
            
            #fontSizeSlider::-webkit-slider-thumb {
                width: 22px;
                height: 22px;
            }
            
            #fontSizeDisplay {
                font-size: 16px;
                min-width: 50px;
            }
        }
        
        @media (max-width: 480px) {
            .font-size-controls {
                padding: 10px;
            }
            
            .font-btn {
                padding: 12px 16px;
                font-size: 18px;
            }
            
            #fontSizeSlider {
                width: 180px;
            }
            
            #fontSizeDisplay {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="search-container">
        <div class="search-header">
            <h1>📚 题目搜索</h1>
            <p>搜索所有题目，支持关键词搜索和类型筛选</p>
            
            <!-- 字体大小控制 -->
            <div class="font-size-controls">
                <label for="fontSizeSlider">字体大小:</label>
                <button class="font-btn" onclick="decreaseFontSize()">A-</button>
                <input type="range" id="fontSizeSlider" min="8" max="64" value="16" step="1" oninput="changeFontSize(this.value)">
                <button class="font-btn" onclick="increaseFontSize()">A+</button>
                <span id="fontSizeDisplay">16px</span>
            </div>
        </div>
        
        <div class="search-box">
            <input type="text" class="search-input" id="searchInput" placeholder="输入关键词搜索题目内容..." />
            <button class="search-btn" onclick="searchQuestions()">🔍 搜索</button>
        </div>
        
        <div class="filter-options">
            <div class="filter-group">
                <label>科目:</label>
                <div class="question-type-filters">
                    <label><input type="checkbox" id="manufacturing" checked> 制造智能技术基础</label>
                    <label><input type="checkbox" id="data" checked> 数据技术基础</label>
                    <label><input type="checkbox" id="industrial" checked> 工业互联网基础</label>
                </div>
            </div>
            
            <div class="filter-group">
                <label for="chapterSelect">章节:</label>
                <select id="chapterSelect" class="chapter-select">
                    <option value="all">全部章节</option>
                    <option value="chapter1">第1章 概论</option>
                    <option value="chapter2">第2章 智能优化技术</option>
                    <option value="chapter3">第3章 模式与图像识别</option>
                    <option value="chapter3-1">第3章-1 模式与图像识别</option>
                    <option value="chapter3-2">第3章-2 模式与图像识别</option>
                    <option value="chapter4">第4章 模糊控制</option>
                    <option value="chapter5">第5章 神经网络</option>
                    <option value="chapter6">第6章 大数据基础</option>
                    <option value="chapter7">第7章 大数据处理结构</option>
                    <option value="chapter8">第8章 分布式文件系统 HDFS</option>
                    <option value="chapter9">第9章 分布式数据库 HBase</option>
                    <option value="chapter10">第10章 NoSql数据库</option>
                    <option value="chapter11">第11章 MapReduce</option>
                    <option value="chapter12">第12章 Spark</option>
                    <option value="chapter13">题库（模拟）</option>
                    <option value="chapter14">选择题（新版模拟）</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>题目类型:</label>
                <div class="question-type-filters">
                    <label><input type="checkbox" id="singleChoice" checked> 单选题</label>
                    <label><input type="checkbox" id="multipleChoice" checked> 多选题</label>
                    <label><input type="checkbox" id="trueFalse" checked> 判断题</label>
                    <label><input type="checkbox" id="fillBlank" checked> 填空题</label>
                    <label><input type="checkbox" id="essay" checked> 简答题</label>
                </div>
            </div>
        </div>
        
        <div id="resultsInfo" class="results-info" style="display: none;"></div>
        <div id="searchResults"></div>
    </div>
    
    <script>
        let allQuestions = [];
        let filteredQuestions = [];
        let searchTimeout = null;
        
        // 章节文件映射
        const chapterFiles = {
            'chapter1': 'chapter1.html',
            'chapter2': 'chapter2.html',
            'chapter3': 'chapter3.html',
            'chapter3-1': 'chapter3-1.html',
            'chapter3-2': 'chapter3-2.html',
            'chapter4': 'chapter4.html',
            'chapter5': 'chapter5.html',
            'chapter6': 'chapter6.html',
            'chapter7': 'chapter7.html',
            'chapter8': 'chapter8.html',
            'chapter9': 'chapter9.html',
            'chapter10': 'chapter10.html',
            'chapter11': 'chapter11.html',
            'chapter12': 'chapter12.html',
            'chapter13': 'chapter13.html',
            'chapter14': 'chapter14.html'
        };
      
        // 科目与章节的映射关系
        const subjectChapterMapping = {
            manufacturing: ['chapter1', 'chapter2', 'chapter3', 'chapter3-1', 'chapter3-2', 'chapter4', 'chapter5'],
            data: ['chapter6', 'chapter7', 'chapter8', 'chapter9', 'chapter10', 'chapter11', 'chapter12'],
            industrial: ['chapter13','chapter14']
        };
        
        // 获取选中的科目对应的章节
        function getSelectedSubjectChapters() {
            const selectedSubjects = [];
            if (document.getElementById('manufacturing').checked) selectedSubjects.push('manufacturing');
            if (document.getElementById('data').checked) selectedSubjects.push('data');
            if (document.getElementById('industrial').checked) selectedSubjects.push('industrial');
            
            if (selectedSubjects.length === 0) {
                return Object.keys(chapterFiles); // 如果没有选中任何科目，返回所有章节
            }
            
            let chapters = [];
            selectedSubjects.forEach(subject => {
                chapters = chapters.concat(subjectChapterMapping[subject]);
            });
            return chapters;
        }
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', async () => {
            showLoading();
            await loadAllQuestions();
            hideLoading();
            
            // 绑定实时搜索（带防抖）
            document.getElementById('searchInput').addEventListener('input', (e) => {
                // 清除之前的定时器
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
                
                // 设置新的定时器，300ms后执行搜索
                searchTimeout = setTimeout(() => {
                    searchQuestions();
                }, 300);
            });
            
            // 绑定回车键搜索（立即搜索）
            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    // 清除防抖定时器
                    if (searchTimeout) {
                        clearTimeout(searchTimeout);
                    }
                    searchQuestions();
                }
            });
            
            // 绑定筛选器变化事件
            document.getElementById('chapterSelect').addEventListener('change', searchQuestions);
            document.querySelectorAll('.question-type-filters input').forEach(checkbox => {
                checkbox.addEventListener('change', searchQuestions);
            });
            
            // 绑定科目复选框变化事件
            document.getElementById('manufacturing').addEventListener('change', searchQuestions);
            document.getElementById('data').addEventListener('change', searchQuestions);
            document.getElementById('industrial').addEventListener('change', searchQuestions);
        });
        
        // 显示加载状态
        function showLoading() {
            document.getElementById('searchResults').innerHTML = '<div class="loading">正在加载题目数据...</div>';
        }
        
        // 隐藏加载状态
        function hideLoading() {
            const loadingElement = document.querySelector('.loading');
            if (loadingElement) {
                loadingElement.remove();
            }
        }
        
        // 加载所有章节的题目
        async function loadAllQuestions() {
            allQuestions = [];
            
            for (const [chapterKey, fileName] of Object.entries(chapterFiles)) {
                try {
                    const response = await fetch(fileName);
                    if (response.ok) {
                        const htmlContent = await response.text();
                        const questions = parseQuestionsFromHTML(htmlContent, chapterKey);
                        allQuestions.push(...questions);
                    }
                } catch (error) {
                    console.warn(`无法加载 ${fileName}:`, error);
                }
            }
            
            console.log(`总共加载了 ${allQuestions.length} 道题目`);
        }
        
        // 从HTML内容中解析题目
        function parseQuestionsFromHTML(htmlContent, chapterKey) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            const questions = [];
            
            // 查找所有题目段落
            const questionElements = doc.querySelectorAll('p strong');
            
            questionElements.forEach(element => {
                const questionText = element.textContent.trim();
                
                // 跳过非题目内容 - 更准确的题目识别
                if (!questionText.match(/^\d+\s/) && !questionText.includes('填空题') && !questionText.includes('判断题') && !/(简答|说明|论述|分析|\[简答\])/.test(questionText)) {
                    return;
                }
                
                const question = {
                    chapter: chapterKey,
                    question: questionText,
                    options: [],
                    correctAnswers: [],
                    type: 'unknown'
                };
                
                // 优先检查明确标注的题目类型
                // 检查是否为填空题（优先级最高）
                if (/_{3,}/.test(questionText) || questionText.includes('填空题')) {
                    question.type = 'fill-blank';
                    
                    // 查找答案
                    let currentElement = element.parentElement.nextElementSibling;
                    while (currentElement) {
                        if (currentElement.tagName === 'DETAILS') {
                            // 使用innerHTML保留HTML格式，包括公式和li标签
                            const answerHTML = currentElement.innerHTML.trim();
                            // 移除summary标签内容，保留其他HTML格式
                            const cleanAnswerHTML = answerHTML.replace(/<summary[^>]*>.*?<\/summary>/gi, '').trim();
                            question.correctAnswers = [cleanAnswerHTML];
                            break;
                        }
                        currentElement = currentElement.nextElementSibling;
                    }
                    
                    questions.push(question);
                    return;
                }
                
                // 检查是否为简答题
                const essayPattern = /(简答|说明|论述|分析|\[简答\])/;
                if (essayPattern.test(questionText)) {
                    question.type = 'essay';
                    
                    // 查找答案
                    let currentElement = element.parentElement.nextElementSibling;
                    while (currentElement) {
                        if (currentElement.tagName === 'DETAILS') {
                            // 使用innerHTML保留HTML格式，包括公式和li标签
                            const answerHTML = currentElement.innerHTML.trim();
                            // 移除summary标签内容，保留其他HTML格式
                            const cleanAnswerHTML = answerHTML.replace(/<summary[^>]*>.*?<\/summary>/gi, '').trim();
                            question.correctAnswers = [cleanAnswerHTML];
                            break;
                        }
                        currentElement = currentElement.nextElementSibling;
                    }
                    
                    questions.push(question);
                    return;
                }
                
                // 处理选择题和判断题
                let currentElement = element.parentElement.nextElementSibling;
                
                // 查找选项列表
                while (currentElement && currentElement.tagName === 'UL' && currentElement.classList.contains('contains-task-list')) {
                    const listItems = currentElement.querySelectorAll('li.task-list-item');
                    
                    listItems.forEach(li => {
                        const checkbox = li.querySelector('input[type="checkbox"]');
                        const rawText = li.textContent.trim();
                        
                        if (checkbox && rawText) {
                            // 清理选项文本
                            const cleanText = rawText.replace(/^[A-Z]\s*[.、]\s*/, '');
                            question.options.push(cleanText);
                            
                            if (checkbox.checked) {
                                question.correctAnswers.push(cleanText);
                            }
                        }
                    });
                    
                    currentElement = currentElement.nextElementSibling;
                }
                
                // 确定题目类型
                if (question.options.length > 0) {
                    if (question.correctAnswers.length > 1) {
                        question.type = 'multiple-choice';
                    } else if (question.options.length === 2 && 
                              (question.options.some(opt => opt.includes('正确')) && 
                               question.options.some(opt => opt.includes('错误')))) {
                        question.type = 'true-false';
                    } else {
                        question.type = 'single-choice';
                    }
                    
                    questions.push(question);
                }
            });
            
            return questions;
        }
        
        // 搜索题目
        function searchQuestions() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const selectedChapter = document.getElementById('chapterSelect').value;
            const selectedSubjectChapters = getSelectedSubjectChapters();
            
            // 获取选中的题目类型
            const selectedTypes = [];
            if (document.getElementById('singleChoice').checked) selectedTypes.push('single-choice');
            if (document.getElementById('multipleChoice').checked) selectedTypes.push('multiple-choice');
            if (document.getElementById('trueFalse').checked) selectedTypes.push('true-false');
            if (document.getElementById('fillBlank').checked) selectedTypes.push('fill-blank');
            if (document.getElementById('essay').checked) selectedTypes.push('essay');
            
            // 筛选题目
            filteredQuestions = allQuestions.filter(question => {
                // 科目筛选（基于章节）
                if (!selectedSubjectChapters.includes(question.chapter)) {
                    return false;
                }
                
                // 章节筛选
                if (selectedChapter !== 'all' && question.chapter !== selectedChapter) {
                    return false;
                }
                
                // 类型筛选
                if (!selectedTypes.includes(question.type)) {
                    return false;
                }
                
                // 关键词搜索
                if (searchTerm) {
                    const questionContent = question.question.toLowerCase();
                    const optionsContent = question.options.join(' ').toLowerCase();
                    const answersContent = question.correctAnswers.join(' ').toLowerCase();
                    
                    return questionContent.includes(searchTerm) || 
                           optionsContent.includes(searchTerm) || 
                           answersContent.includes(searchTerm);
                }
                
                return true;
            });
            
            displayResults();
        }
        
        // 显示搜索结果
        function displayResults() {
            const resultsContainer = document.getElementById('searchResults');
            const resultsInfo = document.getElementById('resultsInfo');
            
            if (filteredQuestions.length === 0) {
                resultsInfo.style.display = 'none';
                resultsContainer.innerHTML = '<div class="no-results">😔 没有找到匹配的题目</div>';
                return;
            }
            
            // 显示结果统计
            resultsInfo.style.display = 'block';
            resultsInfo.textContent = `找到 ${filteredQuestions.length} 道题目`;
            
            // 生成题目HTML
            const questionsHTML = filteredQuestions.map((question, index) => {
                return generateQuestionHTML(question, index + 1);
            }).join('');
            
            resultsContainer.innerHTML = questionsHTML;
            
            // 重新应用字体大小设置
            updateFontSize();
        }
        
        // 高亮关键词函数
        function highlightKeywords(text, keywords) {
            if (!keywords || keywords.trim() === '') {
                return text;
            }
            
            // 将关键词按空格分割，支持多个关键词
            const keywordList = keywords.trim().split(/\s+/);
            let highlightedText = text;
            
            keywordList.forEach(keyword => {
                if (keyword.length > 0) {
                    // 创建正则表达式，忽略大小写
                    const regex = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                    highlightedText = highlightedText.replace(regex, '<mark style="background-color: #ffeb3b; color: #000; padding: 1px 2px; border-radius: 2px; font-weight: 600;">$1</mark>');
                }
            });
            
            return highlightedText;
        }
        
        // 在HTML内容中高亮关键词，避免破坏HTML结构
        function highlightKeywordsInHTML(htmlContent, keywords) {
            if (!keywords || keywords.trim() === '') {
                return htmlContent;
            }
            
            // 创建临时DOM元素来解析HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            
            // 递归处理文本节点
            function processTextNodes(node) {
                if (node.nodeType === Node.TEXT_NODE) {
                    // 对文本节点应用关键词高亮
                    const highlightedText = highlightKeywords(node.textContent, keywords);
                    if (highlightedText !== node.textContent) {
                        const wrapper = document.createElement('span');
                        wrapper.innerHTML = highlightedText;
                        node.parentNode.replaceChild(wrapper, node);
                    }
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    // 递归处理子节点
                    const children = Array.from(node.childNodes);
                    children.forEach(child => processTextNodes(child));
                }
            }
            
            processTextNodes(tempDiv);
            return tempDiv.innerHTML;
        }
        
        // 生成单个题目的HTML
        function generateQuestionHTML(question, index) {
            const chapterName = getChapterName(question.chapter);
            const typeName = getTypeName(question.type);
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            // 高亮题目内容
            const highlightedQuestion = highlightKeywords(question.question, searchTerm);
            
            let optionsHTML = '';
            if (question.options.length > 0) {
                optionsHTML = `
                    <div class="question-options">
                        ${question.options.map(option => {
                            const isCorrect = question.correctAnswers.includes(option);
                            const highlightedOption = highlightKeywords(option, searchTerm);
                            return `<div class="option-item ${isCorrect ? 'correct' : ''}">${highlightedOption}</div>`;
                        }).join('')}
                    </div>
                `;
            }
            
            let answerHTML = '';
            if (question.correctAnswers.length > 0) {
                let answersContent = '';
                if (question.type === 'essay' || question.type === 'fill-blank') {
                    // 对于简答题和填空题，答案可能包含HTML格式，直接使用HTML内容
                    answersContent = question.correctAnswers.map(answer => {
                        // 对HTML内容进行关键词高亮，但要小心处理HTML标签
                        return highlightKeywordsInHTML(answer, searchTerm);
                    }).join('<br><br>');
                } else {
                    // 对于选择题和判断题，使用原有逻辑
                    answersContent = question.correctAnswers.map(answer => 
                        highlightKeywords(answer, searchTerm)
                    ).join('; ');
                }
                answerHTML = `
                    <div class="answer-section">
                        <div class="answer-label">参考答案:</div>
                        <div class="answer-content">${answersContent}</div>
                    </div>
                `;
            }
            
            return `
                <div class="question-item">
                    <div class="question-meta">
                        <span class="chapter-tag">${chapterName}</span>
                        <span class="question-type-tag">${typeName}</span>
                        <button class="locate-btn" onclick="locateToChapter('${question.chapter}', '${question.question.replace(/'/g, "\\'")}')" title="定位到题目">
                            📍 定位
                        </button>
                    </div>
                    <div class="question-content">${highlightedQuestion}</div>
                    ${optionsHTML}
                    ${answerHTML}
                </div>
            `;
        }
        
        // 获取章节名称
        function getChapterName(chapterKey) {
            const chapterNames = {
                'chapter1': '第1章 概论',
                'chapter2': '第2章 智能优化技术',
                'chapter3': '第3章-3 模式与图像识别',
                'chapter3-1': '第3章-1 模式与图像识别',
                'chapter3-2': '第3章-2 模式与图像识别',
                'chapter4': '第4章 模糊控制',
                'chapter5': '第5章 神经网络',
                'chapter6': '第6章 大数据基础',
                'chapter7': '第7章 大数据处理结构',
                'chapter8': '第8章 分布式文件系统 HDFS',
                'chapter9': '第9章 分布式数据库 HBase',
                'chapter10': '第10章 NoSql数据库',
                'chapter11': '第11章 MapReduce',
                'chapter12': '第12章 Spark',
                'chapter13': '第13章 题库（模拟）'
            };
            return chapterNames[chapterKey] || chapterKey;
        }
        
        // 获取题目类型名称
        function getTypeName(type) {
            const typeNames = {
                'single-choice': '单选题',
                'multiple-choice': '多选题',
                'true-false': '判断题',
                'fill-blank': '填空题',
                'essay': '简答题'
            };
            return typeNames[type] || '未知类型';
        }
        
        // 定位到章节和题目函数
        function locateToChapter(chapterKey, questionText = null) {
            // 章节文件名到索引的映射（注意：索引0是题目搜索页面）
            const chapterFileToIndex = {
                'chapter1': 1,
                'chapter2': 2,
                'chapter3-1': 3,
                'chapter3-2': 4,
                'chapter3': 5,
                'chapter4': 6,
                'chapter5': 7,
                'chapter6': 8,
                'chapter7': 9,
                'chapter8': 10,
                'chapter9': 11,
                'chapter10': 12,
                'chapter11': 13,
                'chapter12': 14,
                'IndustrialInternet': 15,
                'chapter13': 16
            };
            
            const chapterIndex = chapterFileToIndex[chapterKey];
            if (chapterIndex !== undefined) {
                // 向父页面发送消息，请求切换到指定章节并定位题目
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'navigateToChapter',
                        chapterIndex: chapterIndex,
                        chapterKey: chapterKey,
                        questionText: questionText
                    }, '*');
                } else {
                    // 如果不在iframe中，直接跳转到主页面
                    const url = questionText ? 
                        `../index.html#${chapterIndex}?q=${encodeURIComponent(questionText)}` : 
                        `../index.html#${chapterIndex}`;
                    window.location.href = url;
                }
            }
        }
        
        // 初始显示所有题目
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (allQuestions.length > 0) {
                    searchQuestions();
                }
            }, 1000);
        });
        
        // 字体大小控制功能
        let currentFontSize = 16;
        
        function changeFontSize(size) {
            currentFontSize = parseInt(size);
            updateFontSize();
            updateFontSizeDisplay();
        }
        
        function increaseFontSize() {
            if (currentFontSize < 64) {
                currentFontSize += 1;
                document.getElementById('fontSizeSlider').value = currentFontSize;
                updateFontSize();
                updateFontSizeDisplay();
            }
        }
        
        function decreaseFontSize() {
            if (currentFontSize > 8) {
                currentFontSize -= 1;
                document.getElementById('fontSizeSlider').value = currentFontSize;
                updateFontSize();
                updateFontSizeDisplay();
            }
        }
        
        function updateFontSize() {
            const elements = [
                '.question-content',
                '.option-item',
                '.answer-content',
                '.search-input',
                '.search-btn',
                '.chapter-select',
                '.question-type-filters label',
                '.results-info',
                '.font-size-controls label',
                '.font-btn',
                '#fontSizeDisplay',
                'body'
            ];
            
            elements.forEach(selector => {
                const nodeList = document.querySelectorAll(selector);
                nodeList.forEach(element => {
                    if (selector === 'body') {
                        element.style.fontSize = currentFontSize + 'px';
                    } else if (selector === '.question-content') {
                        element.style.fontSize = (currentFontSize + 2) + 'px';
                    } else if (selector === '.search-input' || selector === '.search-btn') {
                        element.style.fontSize = currentFontSize + 'px';
                    } else {
                        element.style.fontSize = currentFontSize + 'px';
                    }
                });
            });
            
            // 保存字体大小设置到localStorage
            localStorage.setItem('searchPageFontSize', currentFontSize);
        }
        
        function updateFontSizeDisplay() {
            document.getElementById('fontSizeDisplay').textContent = currentFontSize + 'px';
        }
        
        // 页面加载时恢复字体大小设置
        document.addEventListener('DOMContentLoaded', () => {
            const savedFontSize = localStorage.getItem('searchPageFontSize');
            if (savedFontSize) {
                currentFontSize = parseInt(savedFontSize);
                document.getElementById('fontSizeSlider').value = currentFontSize;
                updateFontSizeDisplay();
                // 延迟应用字体大小，确保页面元素已加载
                setTimeout(() => {
                    updateFontSize();
                }, 100);
            }
        });
    </script>
</body>
</html>